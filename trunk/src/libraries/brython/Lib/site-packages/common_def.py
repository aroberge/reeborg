import sys
from browser import window, doc
from highlight import insert_highlight_info

window['insert_highlight_info'] = insert_highlight_info
library = window['library']


def _write(data):
    doc["output-pre"].innerHTML += str(data)


def _write_err(data):
    doc["output-pre"].innerHTML += "<b style='color:red'>" + str(data) + "</b>"


sys.stdout.write = _write
sys.stderr.write = _write_err


def generic_translate_python(src, lib, lang_import):
    ''' Translate Python code into Javascript and execute

        src: source code in editor
        lib: language specific lib (e.g. my_lib in English, biblio in French)
             already imported in html file
        lang_import: something like "from reeborg_en import *"
    '''
    # save initial state of lib
    initial_lib_dict = {}
    for key in lib.__dict__:
        initial_lib_dict[key] = lib.__dict__[key]

    exec(library.getValue(), lib.__dict__)
    exec(lang_import)
    exec(src)

    # remove added definitions
    new_keys = []
    for key in lib.__dict__:
        if key not in initial_lib_dict:
            new_keys.append(key)
        else:
            lib.__dict__[key] = initial_lib_dict[key]

    for key in new_keys:
        del lib.__dict__[key]
