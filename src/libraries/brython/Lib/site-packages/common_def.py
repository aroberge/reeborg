import sys
from browser import window
from highlight import insert_highlight_info
from preprocess import transform


def _write(data):
    window.RUR.control._write(str(data))


def __write(data):
    window.RUR.control.write(str(data))


def __write_err(data):
    window.RUR.control.write("<b style='color:red'>" + str(data) + "</b>")


sys.stdout.write = __write
sys.stderr.write = __write_err


def generic_translate_python(src, lib, lang_import, highlight,
                             pre_code='', post_code=''):
    ''' Translate Python code into Javascript and execute

        src: source code in editor
        lib: string - language specific lib (e.g. "library" in English, "biblio" in French)
             already imported in html file
        lang_import: something like "from reeborg_en import *"
    '''
    if lib in sys.modules:
        del sys.modules[lib]
    globals_ = {}
    src = transform(src)
    exec(lang_import, globals_)
    if highlight:
        temp_src, problem = insert_highlight_info(src)
        if hasattr(window.RUR, "__debug"):
            window.console.log(temp_src)
        if not problem:
            src = temp_src
        else:
            exec("RUR.ui.highlight('{}')".format(problem), globals_)
            window.jQuery("#highlight-impossible").show()
    src = "help=Help\n" + pre_code + "\n" + src + "\n" + post_code
    exec(src, globals_)

